<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CERBERUS | RAMAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --azul: #1A365D; --oro: #FFD700; --fondo: #F4F7FE; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: var(--fondo); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 250px; background: var(--azul); color: white; padding: 20px; flex-shrink: 0; }
        .sidebar h2 { color: var(--oro); margin-bottom: 30px; text-align: center; font-size: 22px; }
        .btn-menu { width: 100%; padding: 15px; background: transparent; border: none; color: white; text-align: left; cursor: pointer; font-size: 16px; border-radius: 8px; margin-bottom: 5px; display: block; transition: 0.3s; }
        .btn-menu:hover { background: rgba(255,255,255,0.1); }
        .btn-menu.active { background: var(--oro) !important; color: var(--azul) !important; font-weight: bold; }

        .main { flex-grow: 1; padding: 30px; overflow-y: auto; height: 100vh; }
        .seccion { display: none; } 
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        #mapa-contenedor { height: 500px; width: 100%; border-radius: 12px; border: 3px solid var(--azul); z-index: 1; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 20px; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 10px; }
        th { background: #f8f8f8; color: var(--azul); }
        
        .editable-cell { border: 1px solid transparent; background: transparent; padding: 4px; border-radius: 4px; width: 100%; font-weight: bold; }
        .editable-cell:hover { border: 1px solid #ddd; background: #fff; }

        .btn-accion { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; margin: 2px; }
        .bg-verde { background: #48BB78; } .bg-rojo { background: #F56565; } .bg-azul { background: #4299E1; } .bg-gris { background: #718096; }
        
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; color: white; }
        .bg-ramal { background: #2b6cb0; } .bg-andretho { background: #805ad5; }
        
        /* Colores de Estados */
        .st-Programada, .st-Pendiente { color: #B7791F; font-weight: bold; }
        .st-Ejecutada, .st-Completada { color: #2F855A; font-weight: bold; }
        .st-Reprogramar { color: #E53E3E; font-weight: bold; }

        h3 { margin-top: 25px; color: var(--azul); border-left: 4px solid var(--oro); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>CERBERUS</h2>
        <button class="btn-menu active" onclick="abrir('panel', this)"><i class="fas fa-chart-line"></i> Panel General</button>
        <button class="btn-menu" onclick="abrir('mapa-seccion', this); initMap();"><i class="fas fa-map-marked-alt"></i> Mapa de Red</button>
        <button class="btn-menu" onclick="abrir('facturacion', this)"><i class="fas fa-file-invoice"></i> Facturación</button>
        <button class="btn-menu" onclick="abrir('inventario', this)"><i class="fas fa-boxes"></i> Inventario</button>
        <button class="btn-menu" onclick="abrir('tickets', this)"><i class="fas fa-tools"></i> Tickets</button>
        <button class="btn-menu" onclick="abrir('bajas-seccion', this)"><i class="fas fa-user-slash"></i> Bajas de Servicio</button>
        <br><br>
        <a href="index.html" style="color:white; text-decoration:none; padding:15px; display:block;"><i class="fas fa-power-off"></i> Salir</a>
    </div>

    <div class="main">
        <div id="panel" class="seccion" style="display: block;">
            <h1>Panel de Control</h1>
            <div class="card">
                <h3>Estado del Sistema</h3>
                <p style="color: #48BB78;"><i class="fas fa-cloud"></i> Sistema Sincronizado</p>
            </div>
        </div>

        <div id="mapa-seccion" class="seccion">
            <h1>Infraestructura Satelital</h1>
            <div class="card"><div id="mapa-contenedor"></div></div>
            <div class="card">
                <h3>Estado de Puertos y Nodos</h3>
                <table id="tb-naps-container">
                    <thead><tr><th>Nombre</th><th>Nodo</th><th>Empresa</th><th>Coordenadas</th><th>Ocupados</th><th>Libres</th></tr></thead>
                    <tbody id="tb-naps"></tbody>
                </table>
            </div>
        </div>

        <div id="facturacion" class="seccion">
            <div class="header-flex">
                <h1>Facturación</h1> 
                <div>
                    <button class="btn-accion bg-azul" onclick="reporteDiario()">Informe Diario</button>
                    <button class="btn-accion bg-gris" onclick="exportarPDF('Facturacion', 'tb-f-container')">PDF</button>
                </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <input type="text" id="fn" placeholder="N° Fact"> <input type="text" id="fc" placeholder="Cliente"> <input type="number" id="fm" placeholder="Monto">
                    <select id="fo"><option value="RAMAL">RAMAL</option><option value="ANDRETHO">ANDRETHO</option></select>
                    <input type="text" id="fs" placeholder="Secretaria"> <input type="date" id="ff"> <input type="time" id="fh">
                    <button class="btn-accion bg-verde" onclick="addF()">Guardar</button>
                </div>
                <table id="tb-f-container">
                    <thead><tr><th>N° Fact</th><th>Cliente</th><th>Monto</th><th>Cobro</th><th>Secretaria</th><th>Fecha</th><th>Hora</th><th>X</th></tr></thead>
                    <tbody id="tb-f"></tbody>
                </table>
            </div>
        </div>

        <div id="inventario" class="seccion">
            <div class="header-flex"><h1>Inventario</h1> <button class="btn-accion bg-gris" onclick="exportarPDF('Inventario', 'tb-i-container')">PDF</button></div>
            <div class="card">
                <div class="input-group"><input type="text" id="in" placeholder="Material"> <input type="number" id="ic" placeholder="Cantidad"> <button class="btn-accion bg-verde" onclick="addI()">Añadir</button></div>
                <table id="tb-i-container"><thead><tr><th>Material</th><th>Stock</th><th>Acción</th></tr></thead><tbody id="tb-i"></tbody></table>
            </div>
        </div>

        <div id="tickets" class="seccion">
            <div class="header-flex"><h1>Gestión de Tickets</h1></div>
            <div class="card">
                <div class="input-group">
                    <input type="text" id="tc" placeholder="Cliente"> <input type="text" id="ttel" placeholder="Contacto"> <input type="text" id="tder" placeholder="Derivado">
                    <input type="text" id="tz" placeholder="Zona/Barrio"> <input type="text" id="tcoor" placeholder="Coord.">
                    <select id="tempre"><option value="RAMAL">RAMAL</option><option value="ANDRETHO">ANDRETHO</option></select>
                    <select id="tt"><option>Instalación Fibra</option><option>Instalación TV</option><option>Mantenimiento FTTH</option><option>Mantenimiento RG6</option></select>
                    <input type="text" id="ttec" placeholder="Técnico"><input type="date" id="tf"><input type="time" id="th_ticket">
                    <button class="btn-accion bg-verde" onclick="addT()">Programar</button>
                </div>

                <h3>PENDIENTES / EN CURSO <button class="btn-accion bg-gris" onclick="exportarPDF('Tickets_Pendientes', 'tb-t-pend')">PDF</button></h3>
                <table id="tb-t-pend">
                    <thead><tr><th>Red</th><th>Cliente</th><th>Contacto</th><th>Derivado</th><th>Zona</th><th>Coord.</th><th>Tipo</th><th>Técnico</th><th>Fecha</th><th>Hora</th><th>Estado</th><th class="no-pdf">Acción</th></tr></thead>
                    <tbody id="tb-t-prog"></tbody>
                </table>

                <h3>HISTORIAL RAMAL <button class="btn-accion bg-gris" onclick="exportarPDF('Historial_RAMAL', 'tb-h-ramal')">PDF</button></h3>
                <table id="tb-h-ramal"><thead><tr><th>Cliente</th><th>Zona</th><th>Tipo</th><th>Técnico</th><th>Fecha</th><th>Hora</th><th>Estado</th><th class="no-pdf">X</th></tr></thead><tbody id="tb-t-h-ramal"></tbody></table>

                <h3>HISTORIAL ANDRETHO <button class="btn-accion bg-gris" onclick="exportarPDF('Historial_ANDRETHO', 'tb-h-and')">PDF</button></h3>
                <table id="tb-h-and"><thead><tr><th>Cliente</th><th>Zona</th><th>Tipo</th><th>Técnico</th><th>Fecha</th><th>Hora</th><th>Estado</th><th class="no-pdf">X</th></tr></thead><tbody id="tb-t-h-and"></tbody></table>
            </div>
        </div>

        <div id="bajas-seccion" class="seccion">
            <div class="header-flex"><h1>Bajas de Servicio</h1></div>
            <div class="card">
                <div class="input-group">
                    <input type="text" id="bn" placeholder="Nombre Cliente">
                    <input type="text" id="bz" placeholder="Zona">
                    <input type="text" id="bt" placeholder="N° Contacto">
                    <select id="br"><option value="RAMAL">RED RAMAL</option><option value="ANDRETHO">RED ANDRETHO</option></select>
                    <select id="btu"><option value="HOGAR">HOGAR</option><option value="PRO">PRO</option><option value="EMPRESARIAL">EMPRESARIAL</option></select>
                    <input type="date" id="bf"> <input type="time" id="bh">
                    <button class="btn-accion bg-rojo" onclick="addBaja()">Programar Baja</button>
                </div>

                <h3>BAJAS PENDIENTES <button class="btn-accion bg-gris" onclick="exportarPDF('Bajas_Pendientes', 'tb-b-pend')">PDF</button></h3>
                <table id="tb-b-pend">
                    <thead><tr><th>Red</th><th>Cliente</th><th>Zona</th><th>Contacto</th><th>Fecha/Hora</th><th>Tipo</th><th>Estado</th><th class="no-pdf">Acción</th></tr></thead>
                    <tbody id="tb-bajas-list-pend"></tbody>
                </table>

                <h3>HISTORIAL DE BAJAS <button class="btn-accion bg-gris" onclick="exportarPDF('Historial_Bajas', 'tb-b-hist')">PDF</button></h3>
                <table id="tb-b-hist">
                    <thead><tr><th>Red</th><th>Cliente</th><th>Zona</th><th>Fecha</th><th>Tipo</th><th>Estado</th><th class="no-pdf">X</th></tr></thead>
                    <tbody id="tb-bajas-list-hist"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_3HJODPYzPvC_8Z8_e_Xj-39Vw7F-qlg",
            authDomain: "cerberus-ramal.firebaseapp.com",
            projectId: "cerberus-ramal",
            storageBucket: "cerberus-ramal.firebasestorage.app",
            messagingSenderId: "1014200233134",
            appId: "1:1014200233134:web:2f2546047b7ae79f45513f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map;

        function abrir(id, btn) {
            document.querySelectorAll('.seccion').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.btn-menu').forEach(b => b.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            btn.classList.add('active');
        }

        function initMap() {
            if (!map) {
                map = L.map('mapa-contenedor').setView([-17.392, -67.127], 15);
                L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}').addTo(map);
            }
            cargarInfraestructura();
        }

        function cargarInfraestructura() {
            db.collection("infraestructura").orderBy("n").onSnapshot(snap => {
                let h = "";
                map.eachLayer((l) => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
                snap.forEach(doc => {
                    let c = doc.data();
                    h += `<tr><td>${c.n}</td><td><input class="editable-cell" value="${c.nod||''}" onchange="actDoc('infraestructura','${doc.id}','nod',this.value)"></td><td><input class="editable-cell" value="${c.e}" onchange="actDoc('infraestructura','${doc.id}','e',this.value)"></td><td>${c.co[0]}, ${c.co[1]}</td><td><input type="number" class="editable-cell" value="${c.o}" onchange="actDoc('infraestructura','${doc.id}','o',this.value)"></td><td><input type="number" class="editable-cell" value="${c.l}" onchange="actDoc('infraestructura','${doc.id}','l',this.value)"></td></tr>`;
                    L.circleMarker(c.co, {radius:7, color: c.e==='RAMAL'?'blue':'purple', fillColor:'#fff', fillOpacity:0.9}).addTo(map).bindPopup(`<b>${c.n}</b><br>Nodo: ${c.nod||'-'}`);
                });
                document.getElementById('tb-naps').innerHTML = h;
            });
        }

        function cargarTodo() {
            db.collection("facturas").orderBy("ff", "desc").onSnapshot(snap => {
                let h = ""; snap.forEach(doc => {
                    let x = doc.data(); let cl = x.o === 'ANDRETHO' ? 'bg-andretho' : 'bg-ramal';
                    h += `<tr><td>${x.n}</td><td>${x.c}</td><td>${x.m} Bs</td><td><span class="badge ${cl}">${x.o}</span></td><td>${x.sec}</td><td>${x.f}</td><td>${x.h}</td><td><button class="bg-rojo btn-accion" onclick="eliminar('facturas','${doc.id}')">X</button></td></tr>`;
                });
                document.getElementById('tb-f').innerHTML = h;
            });

            db.collection("inventario").onSnapshot(snap => {
                let h = ""; snap.forEach(doc => {
                    let x = doc.data();
                    h += `<tr><td>${x.n}</td><td><input type="number" class="editable-cell" value="${x.c}" onchange="actDoc('inventario','${doc.id}','c',this.value)"></td><td><button class="bg-rojo btn-accion" onclick="eliminar('inventario','${doc.id}')">X</button></td></tr>`;
                });
                document.getElementById('tb-i').innerHTML = h;
            });

            // Tickets con Estados Programada, Ejecutada, Reprogramar
            db.collection("tickets").orderBy("f", "desc").onSnapshot(snap => {
                let hPend = "", hRamal = "", hAnd = "";
                snap.forEach(doc => {
                    let x = doc.data();
                    let cl = x.emp === 'ANDRETHO' ? 'bg-andretho' : 'bg-ramal';
                    if (x.s !== 'Ejecutada') {
                        hPend += `<tr>
                            <td><span class="badge ${cl}">${x.emp}</span></td>
                            <td>${x.c}</td><td>${x.tel}</td><td>${x.d}</td><td>${x.z}</td><td>${x.coor}</td><td>${x.t}</td><td>${x.tec}</td><td>${x.f}</td><td>${x.h}</td>
                            <td class="st-${x.s}">${x.s}</td>
                            <td class="no-pdf">
                                <button class="bg-azul btn-accion" onclick="cambiarEstadoTicket('${doc.id}','Ejecutada')" title="Finalizar"><i class="fas fa-check"></i></button>
                                <button class="bg-rojo btn-accion" onclick="cambiarEstadoTicket('${doc.id}','Reprogramar')" title="Reprogramar"><i class="fas fa-redo"></i></button>
                                <button class="bg-gris btn-accion" onclick="cambiarEstadoTicket('${doc.id}','Programada')" title="Pendiente"><i class="fas fa-clock"></i></button>
                            </td>
                        </tr>`;
                    } else {
                        let fila = `<tr><td>${x.c}</td><td>${x.z}</td><td>${x.t}</td><td>${x.tec}</td><td>${x.f}</td><td>${x.h}</td><td class="st-Ejecutada">Ejecutada</td><td><button class="bg-rojo btn-accion" onclick="eliminar('tickets','${doc.id}')">X</button></td></tr>`;
                        if(x.emp === 'ANDRETHO') hAnd += fila; else hRamal += fila;
                    }
                });
                document.getElementById('tb-t-prog').innerHTML = hPend;
                document.getElementById('tb-t-h-ramal').innerHTML = hRamal;
                document.getElementById('tb-t-h-and').innerHTML = hAnd;
            });

            db.collection("bajas").orderBy("f", "desc").onSnapshot(snap => {
                let hP = "", hH = "";
                snap.forEach(doc => {
                    let b = doc.data();
                    let cl = b.r === 'ANDRETHO' ? 'bg-andretho' : 'bg-ramal';
                    if (b.s === 'Pendiente') {
                        hP += `<tr><td><span class="badge ${cl}">${b.r}</span></td><td>${b.n}</td><td>${b.z}</td><td>${b.t}</td><td>${b.f} ${b.h}</td><td>${b.tu}</td><td class="st-Pendiente">Pendiente</td><td><button class="bg-azul btn-accion" onclick="actDoc('bajas','${doc.id}','s','Completada')"><i class="fas fa-check"></i></button></td></tr>`;
                    } else {
                        hH += `<tr><td><span class="badge ${cl}">${b.r}</span></td><td>${b.n}</td><td>${b.z}</td><td>${b.f}</td><td>${b.tu}</td><td class="st-Completada">Completada</td><td><button class="bg-rojo btn-accion" onclick="eliminar('bajas','${doc.id}')">X</button></td></tr>`;
                    }
                });
                document.getElementById('tb-bajas-list-pend').innerHTML = hP;
                document.getElementById('tb-bajas-list-hist').innerHTML = hH;
            });
        }

        function addT() {
            db.collection("tickets").add({
                c: document.getElementById('tc').value, tel: document.getElementById('ttel').value,
                d: document.getElementById('tder').value, z: document.getElementById('tz').value,
                coor: document.getElementById('tcoor').value, emp: document.getElementById('tempre').value,
                t: document.getElementById('tt').value, tec: document.getElementById('ttec').value,
                f: document.getElementById('tf').value, h: document.getElementById('th_ticket').value, s: 'Programada'
            });
        }

        function addBaja() {
            db.collection("bajas").add({
                n: document.getElementById('bn').value, z: document.getElementById('bz').value,
                t: document.getElementById('bt').value, r: document.getElementById('br').value,
                tu: document.getElementById('btu').value, f: document.getElementById('bf').value,
                h: document.getElementById('bh').value, s: 'Pendiente'
            });
        }

        function cambiarEstadoTicket(id, nuevoEstado) { db.collection("tickets").doc(id).update({ s: nuevoEstado }); }
        function actDoc(col, id, f, v) { db.collection(col).doc(id).update({ [f]: (f==='o'||f==='l'||f==='c'?parseInt(v):v) }); }
        function addF() { db.collection("facturas").add({ n:document.getElementById('fn').value, c:document.getElementById('fc').value, m:document.getElementById('fm').value, o:document.getElementById('fo').value, sec:document.getElementById('fs').value, f:document.getElementById('ff').value, ff:document.getElementById('ff').value, h:document.getElementById('fh').value }); }
        function addI() { db.collection("inventario").add({ n:document.getElementById('in').value, c:document.getElementById('ic').value }); }
        function eliminar(col, id) { if(confirm('¿Eliminar?')) db.collection(col).doc(id).delete(); }

        function reporteDiario() {
            const hoy = new Date().toISOString().split('T')[0];
            db.collection("facturas").where("ff", "==", hoy).get().then(snap => {
                let r=0, a=0;
                snap.forEach(doc => {
                    let x=doc.data();
                    if(x.o==='ANDRETHO') a+=parseFloat(x.m)||0; else r+=parseFloat(x.m)||0;
                });
                alert(`REPORTE DE COBROS HOY\n\nRAMAL: ${r} Bs.\nANDRETHO: ${a} Bs.\nTOTAL: ${r+a} Bs.`);
            });
        }

        function exportarPDF(titulo, id) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.text("CERBERUS - " + titulo, 14, 15);
            doc.autoTable({ html: '#' + id, startY: 20, didParseCell: function(d) { if(d.column.index === 7 || d.column.index === 11) d.cell.text = ''; } });
            doc.save(`Reporte_${titulo}.pdf`);
        }

        window.onload = cargarTodo;
    </script>
</body>
</html>